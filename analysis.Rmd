---
title: "Analysis of COVID-19 Era Apple Mobility Data"
author: "Madison Ng"
date: "4/12/2021"
output: html_document
bibliography: references.bib
params:
  state: "Wisconsin"
  city: "Madison"
  data: "data/raw_data/applemobilitytrends-2021-03-11.csv"
  seqdata: "output/sort_country_seqs.txt"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE)
```

## Setup

```{r set-parameters}
# set name of global data file used
global_file_to_process <- params$data

# set state to work with
state_to_analyze <- params$state

# set city to work with
city_to_analyze <- params$city

# clean up state name for output files
state_no_spaces <- gsub(state_to_analyze,
                        pattern = " ",
                        replacement = "_")

# clean up city name for output files
city_no_spaces <- gsub(city_to_analyze,
                       pattern = " ",
                       replacement = "_")

# extract core name for output file naming
core_name <- tools::file_path_sans_ext(basename(global_file_to_process))
```

```{r load-packages-functions}
# load packages needed
library("dplyr")
library("readr")
library("ggplot2")
library("tidyr")
library("lubridate")
library("devtools")

# load functions needed
source("code/functions/subset_mobility_data_to_state.R")
source("code/functions/city_county_transport_tally.R")
source("code/functions/convert_to_long_data.R")
```

## Project Description

This rmarkdown project uses `ggplot2`[@ggplot2] and `dplyr` [@dplyr] packages to analyze the Apple Maps mobility data spanning pre-COVID-19 pandemic time, through the initial shutdowns, and the continuing changes over the year.

The goal is to subset data for a specific state, tally up the number of cities and counties in that state with mobility data, and make various plots to visualize these data subsets.

This document analyzes the state of `r state_to_analyze`.

## Subsetting Data

```{r subset-state}
# subset data for chosen state using variables set above
state_subset <- subset_mobility_data_to_state(
  input_file_name = global_file_to_process,
  state_to_subset = state_to_analyze)
```

```{r make-subset-long}
# convert wide subsetted state data to long form
long_subset <- convert_wide_to_long(
  input_wide_data = paste0("output/subset_states_wide/",
                           core_name,
                           "_",
                           state_no_spaces,
                           ".csv"))
```

```{r tallied-subset}
# tally number of cities and counties in the state with mobility data available
tallied_subset <- city_county_transport_tally(
  input_file_name = paste0("output/subset_states_wide/",
                           core_name,
                           "_",
                           state_no_spaces,
                           ".csv"),
  state_to_tally = state_to_analyze)
```

## Figures

```{r plot-tallied}
# generate grouped bar plot of tallied transporation type data
# where location type is on the x axis and location count is on the y axis
tallied_plot <- ggplot(data = tallied_subset,
                       aes(x = geo_type,
                           y = n,
                           fill = transportation_type)) +
  geom_col(position = position_dodge()) +
  labs(title = paste("Tally of cities and/or counties in",
                     state_to_analyze,
                     "with mobility data"),
       x = "Location type",
       y = "Location count")

ggsave(plot = tallied_plot,
       filename = paste0("output/analysis_figures/",
                         core_name,
                         "_",
                         state_no_spaces,
                         "_talllied_plot.png"))

tallied_plot
```

```{r plot-time-series-driving}
# generate line plot for relative driving mobility data across a state where
# date is on the x axis and mean relative mobility is on the y axis
timeseries_plot <- long_subset %>%
  filter(transportation_type == "driving") %>%
  group_by(date) %>%
  summarize(mean_mobility = mean(relative_mobility)) %>%
  ggplot(aes(x = lubridate::ymd(date),
         y = mean_mobility)) +
geom_line() +
  labs(title = paste("Statewide mean realtive mobility driving levels in",
                     state_to_analyze,
                     "during COVID"),
       x = "Date",
       y = "Mean realtive mobility")

ggsave(plot = timeseries_plot,
       filename = paste0("output/analysis_figures/",
                         core_name,
                         "_",
                         state_no_spaces,
                         "_timeseries_plot.png"))

timeseries_plot
```

```{r plot-time-series-city-transport}
# generate time series plot tracking relative mobility across transport types
# for a city

# confirm city name chosen is in data set
city_subset_confirm <- long_subset %>%
  filter(region == city_to_analyze)

if (nrow(city_subset_confirm) == 0) {
  print(paste0(city_to_analyze, ",", state_to_analyze))
  stop("ERROR: City not found. Confirm city name is in data set.")
}

# make sure graph doesn't save from running this chunk if city is incorrect
if (nrow(city_subset_confirm) == 0) {
  stop("ERROR: Graph is empty. Figure will not be saved. Check city name.")
} else {
    city_transport_plot <- city_subset_confirm %>%
  filter(region == city_to_analyze) %>%
  group_by(date) %>%
  ggplot(aes(x = lubridate::ymd(date),
         y = relative_mobility,
         color = transportation_type)) +
geom_line() +
  labs(title = paste("Realtive mobility by transport in",
                     city_to_analyze,
                     "during COVID"),
       x = "Date",
       y = "Realtive mobility")

ggsave(plot = city_transport_plot,
       filename = paste0("output/analysis_figures/",
                         core_name,
                         "_",
                         city_no_spaces,
                         "_",
                         state_no_spaces,
                         "_transport_relative_plot.png"))
  }

city_transport_plot
```

```{r plot-country-sequence-data, fig.height=12}
# read in count of sequence by country (there are 2 columns)
country_seqs <- readr::read_table(params$seqdata,
                                  col_names = c("count",
                                                "country"))

# confirm column count is correct
stopifnot(ncol(country_seqs) == 2)

# create sideways barplot using a log scale x axis, where countries are on the y
# and the sequence counts for each are on the x and sorted by count
country_seq_count_plot <- ggplot(data = country_seqs,
                                 aes(x = count,
                                     y = reorder(country, count))) +
  geom_col() +
  scale_x_log10() +
  labs(title = "SARS-CoV-2 Sequence Counts by Country",
       x = "Sequence Counts",
       y = "Country Name")

ggsave(plot = country_seq_count_plot,
       filename = "output/figures/country_seq_count_plot.png")

country_seq_count_plot
```

## Session Info

```{r session-info}
devtools::session_info()
```


## Sources Cited
